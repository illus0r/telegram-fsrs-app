# Telegram Cloud Storage Architecture

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è Telegram Cloud Storage
- –ú–∞–∫—Å–∏–º—É–º 1024 –∫–ª—é—á–µ–π –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ú–∞–∫—Å–∏–º—É–º 4096 —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ –∑–Ω–∞—á–µ–Ω–∏–µ
- –ö–∞—Ä—Ç–æ—á–∫–∏ Anki –º–æ–≥—É—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å —ç—Ç–∏ –ª–∏–º–∏—Ç—ã

## –ü—Ä–∏–Ω—è—Ç—ã–µ —Ä–µ—à–µ–Ω–∏—è

### üóÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è
- **–ú–µ—Ç–∞-–¥–∞–Ω–Ω—ã–µ**: `cards_meta: {version: 1, last_id: 25, cards_per_batch: 10}`
- **–ë–∞—Ç—á–∏ –∫–∞—Ä—Ç–æ—á–µ–∫**: `cards_batch_0`, `cards_batch_1`, `cards_batch_2`...
- **–†–∞–∑–º–µ—Ä –±–∞—Ç—á–∞**: 10 –∫–∞—Ä—Ç–æ—á–µ–∫ (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)
- **–õ–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞**: –¥–æ 4096 —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ –±–∞—Ç—á

### üìç –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫
- **–ê–ª–≥–æ—Ä–∏—Ç–º**: `batch_number = Math.floor((card_id - 1) / cards_per_batch)`
- **ID –∫–∞—Ä—Ç–æ—á–µ–∫**: –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ 1, 2, 3, 4...
- **–í—ã—á–∏—Å–ª–µ–Ω–∏–µ ID**: `card_id = batch_number * cards_per_batch + index + 1`
- **–ù–æ–≤—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏**: –≤—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ –∫–æ–Ω–µ—Ü
- **–ü—Ä–∏–º–µ—Ä**:
  - `cards_batch_0`: –∫–∞—Ä—Ç–æ—á–∫–∏ —Å ID 1-10
  - `cards_batch_1`: –∫–∞—Ä—Ç–æ—á–∫–∏ —Å ID 11-20
  - `cards_batch_2`: –∫–∞—Ä—Ç–æ—á–∫–∏ —Å ID 21-30

### ‚è∞ –§–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏
- **–§–æ—Ä–º–∞—Ç**: `YYMMDDHHMM` (2512080032)
- **–î–ª–∏–Ω–∞**: 10 —Å–∏–º–≤–æ–ª–æ–≤ –≤–º–µ—Å—Ç–æ 24
- **–≠–∫–æ–Ω–æ–º–∏—è**: -14 —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ –∫–∞–∂–¥—É—é –¥–∞—Ç—É
- **–¢–æ—á–Ω–æ—Å—Ç—å**: –¥–æ –º–∏–Ω—É—Ç, –±–µ–∑ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞

### üîÑ –û–ø–µ—Ä–∞—Ü–∏–∏

#### –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
1. –ß–∏—Ç–∞–µ–º `cards_meta` ‚Üí —É–∑–Ω–∞—ë–º `cards_per_batch` –∏ `last_id`
2. –í—ã—á–∏—Å–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞—Ç—á–µ–π: `Math.ceil(last_id / cards_per_batch)`
3. –ß–∏—Ç–∞–µ–º –≤—Å–µ –±–∞—Ç—á–∏ –æ—Ç `cards_batch_0` –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ
4. –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –ø–∞–º—è—Ç—å, –≤—ã—á–∏—Å–ª—è—è ID –¥–ª—è –∫–∞–∂–¥–æ–π
5. **DELETED –∑–∞–ø–∏—Å–∏ –æ—Å—Ç–∞—é—Ç—Å—è** –≤ –æ–±—ã—á–Ω–æ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ

#### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏
1. –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–º–µ—Ä –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –±–∞—Ç—á–∞: `Math.floor((last_id - 1) / cards_per_batch)`
2. –ï—Å–ª–∏ –±–∞—Ç—á –ø–æ–ª–Ω—ã–π ‚Üí —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –±–∞—Ç—á
3. –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –±–∞—Ç—á
4. –û–±–Ω–æ–≤–ª—è–µ–º `cards_meta.last_id` –∏ –Ω—É–∂–Ω—ã–π –±–∞—Ç—á

#### –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏
1. –í—ã—á–∏—Å–ª—è–µ–º –±–∞—Ç—á: `Math.floor((card_id - 1) / cards_per_batch)`
2. –í—ã—á–∏—Å–ª—è–µ–º –∏–Ω–¥–µ–∫—Å: `(card_id - 1) % cards_per_batch`
3. –ß–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ —ç—Ç–æ—Ç –±–∞—Ç—á
4. –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –ø–æ –∏–Ω–¥–µ–∫—Å—É
5. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–π –±–∞—Ç—á

#### –£–¥–∞–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏
1. –ü–æ–º–µ—á–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –∫–∞–∫ `null` –≤ –±–∞—Ç—á–µ
2. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–π –±–∞—Ç—á
3. **null –≤–ª–∏—è–µ—Ç –Ω–∞ total** –≤ –º–µ—Ç–∞-–¥–∞–Ω–Ω—ã—Ö
4. –ü—Ä–∏ –æ–±—ã—á–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ null –∑–∞–ø–∏—Å–∏ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è

#### –ú–∞—Å—Å–æ–≤–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
1. **–ó–∞–≥—Ä—É–∑–∫–∞**: null –∑–∞–ø–∏—Å–∏ –ù–ï –ø–æ–ø–∞–¥–∞—é—Ç –≤ —Ç–∞–±–ª–∏—Ü—É
2. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ**: –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º –≤—Å–µ –±–∞—Ç—á–∏, —É–¥–∞–ª—è—è null
3. **–ü–µ—Ä–µ—Å—á—ë—Ç ID**: –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è null –ø–µ—Ä–µ–Ω—É–º–µ—Ä–æ–≤—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏
4. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∞**: –Ω–æ–≤—ã–π last_id –±–µ–∑ —É—á—ë—Ç–∞ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö

### üìè –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞

#### –î–ª–∏–Ω–∞ –ø–æ–ª–µ–π –∫–∞—Ä—Ç–æ—á–∫–∏
- **–í–æ–ø—Ä–æ—Å**: –º–∞–∫—Å–∏–º—É–º 200 —Å–∏–º–≤–æ–ª–æ–≤
- **–û—Ç–≤–µ—Ç**: –º–∞–∫—Å–∏–º—É–º 300 —Å–∏–º–≤–æ–ª–æ–≤
- **–û–±—â–∏–π –ª–∏–º–∏—Ç**: 500 —Å–∏–º–≤–æ–ª–æ–≤ + TSV —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- **–í –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ**: –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å—á—ë—Ç—á–∏–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—è
- **–í —Ç–∞–±–ª–∏—Ü–µ**: —Å—á—ë—Ç—á–∏–∫ –Ω–µ –Ω—É–∂–µ–Ω
- **–ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–µ–∑–∞—Ç—å –µ—Å–ª–∏ –¥–ª–∏–Ω–Ω–µ–µ

#### –ü–æ–¥—Å—á—ë—Ç —Å–∏–º–≤–æ–ª–æ–≤
- **–ú–µ—Ç–æ–¥**: `string.length` (UTF-16 code units)
- **–ò–µ—Ä–æ–≥–ª–∏—Ñ—ã**: –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ = 1 —Å–∏–º–≤–æ–ª
- **–≠–º–æ–¥–∑–∏**: –æ–±—ã—á–Ω–æ 2-4 —Å–∏–º–≤–æ–ª–∞
- **–£—á—ë—Ç**: –ª–∏–º–∏—Ç—ã –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫ `string.length`

#### –†–∞—Å—á—ë—Ç —Ä–∞–∑–º–µ—Ä–∞ –±–∞—Ç—á–∞
- TSV —Å—Ç—Ä—É–∫—Ç—É—Ä–∞: ~520 —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É (–≤–∫–ª—é—á–∞—è —Å–ª—É–∂–µ–±–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã)
- 10 –∫–∞—Ä—Ç–æ—á–µ–∫: ~5200 —Å–∏–º–≤–æ–ª–æ–≤ —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏, –Ω–æ –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ ~3500 —Å–∏–º–≤–æ–ª–æ–≤
- –ó–∞–ø–∞—Å –¥–æ –ª–∏–º–∏—Ç–∞ 4096 —Å–∏–º–≤–æ–ª–æ–≤: ~600 —Å–∏–º–≤–æ–ª–æ–≤

### üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

#### –§–æ—Ä–º—É–ª—ã —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
```javascript
const getBatchNumber = (cardId, cardsPerBatch) => 
  Math.floor((cardId - 1) / cardsPerBatch);

const getBatchKey = (batchNumber) => `cards_batch_${batchNumber}`;

const getCardId = (batchNumber, index, cardsPerBatch) => 
  batchNumber * cardsPerBatch + index + 1;

const getCardIndex = (cardId, cardsPerBatch) => 
  (cardId - 1) % cardsPerBatch;
```

#### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–µ—Ç–∞-–¥–∞–Ω–Ω—ã—Ö
```json
{
  "version": 1,
  "last_id": 25,
  "cards_per_batch": 10
}
```

#### –ü—Ä–∏–º–µ—Ä –±–∞—Ç—á–∞ (TSV —Ñ–æ—Ä–º–∞—Ç)
```tsv
–°—Ç–æ–ª–∏—Ü–∞ –§—Ä–∞–Ω—Ü–∏–∏?	–ü–∞—Ä–∏–∂	2512080032
2+2=?	4	2512080045
[DELETED]
–¶–≤–µ—Ç –Ω–µ–±–∞?	–°–∏–Ω–∏–π	2512080100
–î–ª–∏–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å –ø—Ä–æ —á—Ç–æ-—Ç–æ –≤–∞–∂–Ω–æ–µ?	–û—á–µ–Ω—å –ø–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç–≤–µ—Ç —Å –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º –¥–µ—Ç–∞–ª–µ–π –∏ –ø–æ—è—Å–Ω–µ–Ω–∏–π	2512080130
...
```

### üîÑ –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–∏–≥—Ä–∞—Ü–∏—è

#### –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–µ—Ä—Å–∏–π
- **version: 1**: —Ç–µ–∫—É—â–∞—è —Å—Ö–µ–º–∞ (10 –∫–∞—Ä—Ç–æ—á–µ–∫, –±–µ–∑ ID –≤ –±–∞—Ç—á–∞—Ö)
- **–ë—É–¥—É—â–∏–µ –≤–µ—Ä—Å–∏–∏**: –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –±–∞—Ç—á–∞, –Ω–æ–≤—ã–µ –ø–æ–ª—è

#### –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
```json
{
  "version": 2,
  "last_id": 25,
  "cards_per_batch": 15,
  "migration_needed": true,
  "old_cards_per_batch": 10
}
```

#### –ü—Ä–æ—Ü–µ—Å—Å –º–∏–≥—Ä–∞—Ü–∏–∏
1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –ø–æ –≤–µ—Ä—Å–∏–∏
2. –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —Å—Ç–∞—Ä–æ–π —Å—Ö–µ–º–µ
3. –ü–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º –±–∞—Ç—á–∏ –ø–æ–¥ –Ω–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä
4. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –Ω–æ–≤–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
5. –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∞-–¥–∞–Ω–Ω—ã–µ

### üîß TSV —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö

#### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ TSV
- **–§–æ—Ä–º–∞—Ç**: `–≤–æ–ø—Ä–æ—Å\t–æ—Ç–≤–µ—Ç\t–≤—Ä–µ–º—è_—Å–æ–∑–¥–∞–Ω–∏—è`
- **–†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å**: —Ç–∞–±—É–ª—è—Ü–∏—è (\t)
- **DELETED –∑–∞–ø–∏—Å–∏**: —Å—Ç—Ä–æ–∫–∞ `[DELETED]`
- **–≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ**: —Ç–∞–±—ã –≤ —Ç–µ–∫—Å—Ç–µ ‚Üí `\t`, –ø–µ—Ä–µ–Ω–æ—Å—ã ‚Üí `\n`

#### –ü–∞—Ä—Å–∏–Ω–≥ TSV
```javascript
const parseTSV = (tsvString) => {
  return tsvString.split('\n').map(line => {
    if (line === '[DELETED]') return null;
    const [q, a, created] = line.split('\t');
    return {
      q: q?.replace(/\\t/g, '\t').replace(/\\n/g, '\n') || '',
      a: a?.replace(/\\t/g, '\t').replace(/\\n/g, '\n') || '',
      created: created || ''
    };
  });
};

const toTSV = (cards) => {
  return cards.map(card => {
    if (!card) return '[DELETED]';
    const q = card.q.replace(/\t/g, '\\t').replace(/\n/g, '\\n');
    const a = card.a.replace(/\t/g, '\\t').replace(/\n/g, '\\n');
    return `${q}\t${a}\t${card.created}`;
  }).join('\n');
};
```

### ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ—à–µ–Ω–∏—è
- **–≠–∫–æ–Ω–æ–º–∏—è –º–µ—Å—Ç–∞**: TSV vs JSON (-30 —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É)
- **–£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ –ª–∏–º–∏—Ç—ã**: –≤–æ–ø—Ä–æ—Å 200, –æ—Ç–≤–µ—Ç 300 —Å–∏–º–≤–æ–ª–æ–≤
- **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏—è**: —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ –±–∞—Ç—á–∏
- **–ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å**: –ª–µ–≥–∫–æ –Ω–∞–π—Ç–∏ –∫–∞—Ä—Ç–æ—á–∫—É –ø–æ ID
- **–ì–∏–±–∫–æ—Å—Ç—å**: –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–∏–≥—Ä–∞—Ü–∏—è
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –∑–∞–≥—Ä—É–∑–∫–∞ –∑–∞ –º–∏–Ω–∏–º—É–º –∑–∞–ø—Ä–æ—Å–æ–≤ + –±—ã—Å—Ç—Ä—ã–π –ø–∞—Ä—Å–∏–Ω–≥

### üéØ –ò—Ç–æ–≥–æ–≤–∞—è —ç–∫–æ–Ω–æ–º–∏—è
- **–í—Ä–µ–º—è**: —Å 24 –¥–æ 10 —Å–∏–º–≤–æ–ª–æ–≤ (-14 –Ω–∞ –¥–∞—Ç—É)
- **ID**: —É–±—Ä–∞–ª–∏ –∏–∑ –±–∞—Ç—á–µ–π (-15 –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É)
- **–§–æ—Ä–º–∞—Ç**: TSV –≤–º–µ—Å—Ç–æ JSON (-30 –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É)
- **–û–±—â–∞—è —ç–∫–æ–Ω–æ–º–∏—è**: ~300 —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ –±–∞—Ç—á
- **–ë–æ–ª—å—à–µ –º–µ—Å—Ç–∞**: –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤